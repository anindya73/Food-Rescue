<% var bodyHtml = `
<!-- Dashboard Metrics -->
<div class="row g-3 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6 class="text-muted mb-1">Total Donations</h6>
          <h2 class="fw-bold text-success mb-0">${total_donations}</h2>
        </div>
        <i class="bi bi-box-seam fs-1 text-success opacity-25"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6 class="text-muted mb-1">Pending</h6>
          <h2 class="fw-bold text-warning mb-0">${pending_donations}</h2>
        </div>
        <i class="bi bi-clock fs-1 text-warning opacity-25"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6 class="text-muted mb-1">Delivered</h6>
          <h2 class="fw-bold text-primary mb-0">${delivered_donations}</h2>
        </div>
        <i class="bi bi-check-circle fs-1 text-primary opacity-25"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h6 class="text-muted mb-1">Expiring Soon</h6>
          <h2 class="fw-bold text-danger mb-0">${expiring_3days}</h2>
        </div>
        <i class="bi bi-exclamation-triangle fs-1 text-danger opacity-25"></i>
      </div>
    </div>
  </div>
</div>

<!-- System Stats -->
<div class="row g-3 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 text-center">
      <div class="card-body">
        <i class="bi bi-person-badge fs-2 text-success"></i>
        <h3 class="fw-bold mb-0">${total_donors}</h3>
        <p class="text-muted small mb-0">Donors</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 text-center">
      <div class="card-body">
        <i class="bi bi-truck fs-2 text-primary"></i>
        <h3 class="fw-bold mb-0">${total_volunteers}</h3>
        <p class="text-muted small mb-0">Volunteers</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 text-center">
      <div class="card-body">
        <i class="bi bi-people fs-2 text-info"></i>
        <h3 class="fw-bold mb-0">${total_receivers}</h3>
        <p class="text-muted small mb-0">Receivers</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card shadow-sm border-0 text-center">
      <div class="card-body">
        <i class="bi bi-geo-alt fs-2 text-warning"></i>
        <h3 class="fw-bold mb-0">${total_centers}</h3>
        <p class="text-muted small mb-0">Centers</p>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h6 class="fw-semibold mb-3">Quick Actions</h6>
    <div class="d-flex gap-2 flex-wrap">
      <a href="/admin/centers" class="btn btn-success btn-sm"><i class="bi bi-geo-alt me-1"></i>Manage Centers</a>
      <a href="/admin/assign" class="btn btn-primary btn-sm"><i class="bi bi-clipboard-check me-1"></i>Assign Pickups</a>
      <a href="/admin/reports" class="btn btn-warning btn-sm"><i class="bi bi-graph-up me-1"></i>View Reports</a>
    </div>
  </div>
</div>

<!-- Pending Food Requests from Receivers -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold border-bottom">
    <i class="bi bi-box-seam text-danger me-2"></i>Pending Food Requests from Receivers
  </div>
  <div class="card-body">
`;

if (!foodRequests || foodRequests.length === 0) {
  bodyHtml += `<p class="text-muted text-center py-3">No pending food requests.</p>`;
} else {
  bodyHtml += `
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Request Date</th>
            <th>Receiver</th>
            <th>Food Item</th>
            <th>Quantity (kg/units)</th>
            <th>Urgency</th>
            <th>Notes</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  foodRequests.forEach(req => {
  const reqDate = (req.request_date instanceof Date ? req.request_date : new Date(req.request_date));
  const reqDateStr = `${reqDate.getFullYear()}-${String(reqDate.getMonth()+1).padStart(2,'0')}-${String(reqDate.getDate()).padStart(2,'0')}`;
    let urgencyBadge = 'info';
    if (req.urgency === 'High') urgencyBadge = 'danger';
    else if (req.urgency === 'Medium') urgencyBadge = 'warning';
    
    bodyHtml += `
          <tr>
            <td>${reqDateStr}</td>
            <td>${req.receiver_name}</td>
            <td><strong>${req.food_item}</strong></td>
            <td>${req.quantity} kg</td>
            <td><span class="badge bg-${urgencyBadge}">${req.urgency}</span></td>
            <td>${req.notes || '-'}</td>
            <td class="text-center">
              <form method="POST" action="/admin/assign-request/${req.id}" style="display:inline;">
                <div class="input-group input-group-sm">
                  <select name="volunteer_id" class="form-select form-select-sm" required>
                    <option value="">Select Volunteer</option>
    `;
    
    total_volunteers_list.forEach(vol => {
      bodyHtml += `<option value="${vol.id}">${vol.name}</option>`;
    });
    
    bodyHtml += `
                  </select>
                  <button type="submit" class="btn btn-success btn-sm">
                    <i class="bi bi-check-circle me-1"></i>Assign
                  </button>
                </div>
              </form>
              <form method="POST" action="/admin/delete-request/${req.id}" style="display:inline; margin-left: 5px;">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this request?')">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
    `;
  });
  
  bodyHtml += `
        </tbody>
      </table>
    </div>
  `;
}

bodyHtml += `
  </div>
</div>

<!-- Top Donors -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold border-bottom">
    <i class="bi bi-trophy text-warning me-2"></i>Top Donors
  </div>
  <div class="card-body">
`;

if (topDonors.length === 0) {
  bodyHtml += `<p class="text-muted text-center py-3">No donors yet.</p>`;
} else {
  bodyHtml += `
    <table class="table table-sm table-hover mb-0">
      <thead class="table-light">
        <tr><th>Donor</th><th class="text-center">Donations</th><th class="text-end">Total (kg)</th></tr>
      </thead>
      <tbody>
  `;
  topDonors.forEach(d => {
    bodyHtml += `<tr><td>${d.name}</td><td class="text-center">${d.donation_count}</td><td class="text-end">${d.total_qty}</td></tr>`;
  });
  bodyHtml += `
      </tbody>
    </table>
  `;
}

bodyHtml += `
  </div>
</div>

<!-- Volunteer Performance -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold border-bottom">
    <i class="bi bi-star text-primary me-2"></i>Volunteer Performance
  </div>
  <div class="card-body">
`;

if (volPerf.length === 0) {
  bodyHtml += `<p class="text-muted text-center py-3">No volunteers yet.</p>`;
} else {
  bodyHtml += `
    <table class="table table-sm table-hover mb-0">
      <thead class="table-light">
        <tr><th>Volunteer</th><th class="text-center">Assigned</th><th class="text-end">Delivered</th></tr>
      </thead>
      <tbody>
  `;
  volPerf.forEach((v, idx) => {
    const star = idx === 0 ? ' ' : '';
    bodyHtml += `<tr><td>${star}${v.name}</td><td class="text-center">${v.total_assigned}</td><td class="text-end">${v.delivered_count}</td></tr>`;
  });
  bodyHtml += `
      </tbody>
    </table>
  `;
}

bodyHtml += `
  </div>
</div>

<!-- Status Chart -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold border-bottom">
    <i class="bi bi-pie-chart text-info me-2"></i>Status Distribution
  </div>
  <div class="card-body">
`;

if (statusBreakdown.length === 0) {
  bodyHtml += `<p class="text-muted text-center py-3">No data yet.</p>`;
} else {
  bodyHtml += `<canvas id="chartStatus" height="200"></canvas>`;
}

bodyHtml += `
  </div>
</div>

<!-- Available Food Section -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white fw-semibold border-bottom">
    <i class="bi bi-basket text-success me-2"></i>Available Food
  </div>
  <div class="card-body">
`;

if (!availableFood || availableFood.length === 0) {
  bodyHtml += `<p class="text-muted text-center py-3">No available food donations.</p>`;
} else {
  bodyHtml += `
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Item</th>
            <th>Quantity (kg/units)</th>
            <th>Expiry</th>
            <th>Center</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  availableFood.forEach(item => {
  const _itemExp = (item.expiry_date instanceof Date ? item.expiry_date : new Date(item.expiry_date));
  const expiryDate = `${_itemExp.getFullYear()}-${String(_itemExp.getMonth()+1).padStart(2,'0')}-${String(_itemExp.getDate()).padStart(2,'0')}`;
    bodyHtml += `
          <tr>
            <td><strong>${item.food_item}</strong></td>
            <td>${item.quantity}</td>
            <td>${expiryDate}</td>
            <td>${item.center_name}</td>
          </tr>
    `;
  });
  
  bodyHtml += `
        </tbody>
      </table>
    </div>
  `;
}

bodyHtml += `
  </div>
</div>
`;

%>
<%- include('../layout', {
  title: 'Admin Dashboard',
  body: bodyHtml,
  extraScripts: (() => {
    if (statusBreakdown && statusBreakdown.length > 0) {
      return `
      <script>
      document.addEventListener('DOMContentLoaded', function() {
        var el = document.getElementById('chartStatus');
        if (!el || !window.Chart) return;
        var statusData = ` + JSON.stringify(statusBreakdown) + `;
        var labels = statusData.map(s => s.status);
        var counts = statusData.map(s => s.count);
        var colors = { 'Pending':'#ffc107', 'Picked Up':'#0dcaf0', 'Delivered':'#198754', 'Allocated':'#0d6efd', 'Expired':'#dc3545' };
        var bgColors = labels.map(l => colors[l] || '#6c757d');
        new Chart(el, { 
          type: 'doughnut', 
          data: { labels: labels, datasets: [{ data: counts, backgroundColor: bgColors }] }, 
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } 
        });
      });
      </script>`;
    }
    return '';
  })()
}) %>